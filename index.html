<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh-Gateway MVP Documentation</title>
    <style>
        :root {
            --primary: #00a884;
            --bg: #0b141a;
            --sidebar-bg: #111b21;
            --text-main: #e9edef;
            --text-dim: #8696a0;
            --border: #222d34;
            --code-bg: #1d2a35;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-main); line-height: 1.6; display: flex; }
        
        /* Sidebar Navigation */
        nav { width: 280px; height: 100vh; background: var(--sidebar-bg); border-right: 1px solid var(--border); position: fixed; padding: 20px; overflow-y: auto; }
        nav h2 { font-size: 1.2rem; color: var(--primary); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        nav ul { list-style: none; }
        nav li { margin-bottom: 10px; }
        nav a { color: var(--text-dim); text-decoration: none; font-size: 0.95rem; transition: 0.2s; }
        nav a:hover { color: var(--primary); }

        /* Main Content */
        main { margin-left: 280px; padding: 60px 100px; width: 100%; max-width: 1200px; }
        section { margin-bottom: 80px; scroll-margin-top: 60px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        h2 { font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; color: var(--primary); }
        h3 { font-size: 1.3rem; margin: 25px 0 10px; }
        p { margin-bottom: 15px; color: var(--text-main); opacity: 0.9; }
        
        /* Components */
        .badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .table-wrap { overflow-x: auto; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; background: var(--sidebar-bg); border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #182229; color: var(--primary); }
        pre { background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; color: #a5d6ff; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 0.9rem; }
        .diagram-placeholder { background: var(--border); border-radius: 8px; padding: 40px; text-align: center; margin: 20px 0; color: var(--text-dim); border: 2px dashed var(--text-dim); }
        
        @media (max-width: 900px) {
            nav { display: none; }
            main { margin-left: 0; padding: 40px 20px; }
        }
    </style>
</head>
<body>

<nav>
    <h2>Mesh-Gateway</h2>
    <ul>
        <li><a href="#overview">1. System Overview</a></li>
        <li><a href="#hardware">2. Hardware Architecture</a></li>
        <li><a href="#protocols">3. Communication Protocols</a></li>
        <li><a href="#software">4. Software Design</a></li>
        <li><a href="#scaling-memory">5. Constraints & Limits</a></li>
        <li><a href="#roadmap">6. Implementation Roadmap</a></li>
        <li><a href="#dev-env">7. Development Environment & Tooling</a></li>
        <li><a href="#testing">8. Testing & Validation Protocols</a></li>
        <li><a href="#license">9. Licensing & Open Source</a></li>
        <li><a href="#appendix">Appendix: Hardware Assembly & Quick Start</a></li>
    </ul>
</nav>

<main>
    <section id="overview">
        <h1>Mesh-Gateway MVP</h1>
        <p><span class="badge">v1.0.0</span> &nbsp; Technical Specification Documentation</p>
        <p>The Mesh-Gateway is a resilient communication project designed to bridge localized Wi-Fi hotspots with the long-range Meshtastic LoRa network. It allows standard smartphones to access mesh communication without requiring individual LoRa hardware.</p>
        
        
    </section>

    <section id="hardware">
        <h2>2. Hardware Architecture</h2>
        <p>The physical stack consists of a dual-device gateway acting as a bridge between high-bandwidth local Wi-Fi and low-bandwidth long-range radio.</p>
        
        <h3>2.1 The Gateway Stack</h3>
        <ul>
            <li><strong>ESP32:</strong> Handles the Wi-Fi Access Point, Captive Portal, and WebSocket server.</li>
            <li><strong>Meshtastic Node:</strong> Handles the LoRa Physical layer, mesh routing, and frequency hopping.</li>
            <li><strong>Interface:</strong> UART (Universal Asynchronous Receiver/Transmitter) using 3 wires (RX, TX, GND).</li>
        </ul>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>Role</th>
                        <th>Communication Type</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Smartphone</td>
                        <td>End User / PWA UI</td>
                        <td>TCP/IP (Wi-Fi)</td>
                    </tr>
                    <tr>
                        <td>ESP32</td>
                        <td>Social Gateway / Logic</td>
                        <td>WebSocket / UART</td>
                    </tr>
                    <tr>
                        <td>Mesh Node</td>
                        <td>Radio Backhaul</td>
                        <td>LoRa (Sub-GHz)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

	<section id="protocols">
        <h2>3. Communication Protocols</h2>
        <p>This section defines how data is encapsulated as it moves between the User, the ESP32 Gateway, and the LoRa Mesh.</p>
        
        <h3>3.1 Physical Interconnect (UART)</h3>
        <p>The <strong>ESP32-C3 Super Mini</strong> connects to the <strong>XIAO nRF52840</strong> via a 3-wire Serial cross-over:</p>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>ESP32-C3 Pin</th>
                        <th>XIAO nRF52840 Pin</th>
                        <th>Function</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>GPIO 21 (TX)</td>
                        <td>RX (D7)</td>
                        <td>Data to Mesh</td>
                    </tr>
                    <tr>
                        <td>GPIO 20 (RX)</td>
                        <td>TX (D6)</td>
                        <td>Data from Mesh</td>
                    </tr>
                    <tr>
                        <td>GND</td>
                        <td>GND</td>
                        <td>Common Ground</td>
                    </tr>
                </tbody>
            </table>
        </div>

        

        <h3 id="option-b">3.2 Primary Protocol: Condensed JSON (Option B)</h3>
        <p>For the Pilot phase, we use <strong>Condensed JSON</strong>. This ensures ease of debugging while allowing the ESP32 to route messages to specific users.</p>
        <pre>
// Format: 
{
  "s": "Alice",    // Sender Name (Short Key: s)
  "i": "u123",     // Sender UUID (Short Key: i)
  "m": "Hello!",   // Message Text (Short Key: m)
  "r": "1"         // Room/Channel ID (Short Key: r)
}
        </pre>
        <p><em>Note: Keys are minimized to a single character to reduce LoRa airtime consumption.</em></p>

        

        <h3 id="option-c" style="opacity: 0.7;">3.3 Future Reference: SLIP/Binary (Option C)</h3>
        <p style="color: var(--text-dim)"><em>Proposed for Version 2.0 to maximize LoRa bandwidth efficiency.</em></p>
        <p>The Binary protocol will utilize Serial Line IP (SLIP) framing to wrap Meshtastic Protobufs directly, bypassing string parsing entirely.</p>
        
        <div class="table-wrap">
            <table>
                <tr>
                    <th>Byte 0</th>
                    <td>START_FRAME (0xC0)</td>
                </tr>
                <tr>
                    <th>Byte 1-4</th>
                    <td>SENDER_ID (Uint32)</td>
                </tr>
                <tr>
                    <th>Byte 5</th>
                    <td>FLAGS (Priority, ACK required)</td>
                </tr>
                <tr>
                    <th>Byte 6-N</th>
                    <td>RAW_PAYLOAD (Protobuf)</td>
                </tr>
                <tr>
                    <th>Final Byte</th>
                    <td>END_FRAME (0xC0)</td>
                </tr>
            </table>
        </div>

        
    </section>
	
	<section id="software">
		<h2>4. Software Design & Advanced Routing</h2>
		
		<h3>4.1 Split-Horizon Loop Prevention</h3>
		<p>The ESP32-C3 implements <strong>Split-Horizon Routing</strong>. Data received from the Serial (XIAO) interface is marked with a <code>INTERNAL_ONLY</code> flag. This ensures the Gateway never re-broadcasts mesh-originated data back into the mesh, preventing infinite loops.</p>

		<h3>4.2 User Mapping (Node Sub-Addressing)</h3>
		<p>Because the LoRa mesh treats the Gateway as a single Node, the ESP32 manages a "Virtual Port" system for the 5 connected users.</p>
		<ul>
			<li><strong>Discovery:</strong> ESP32 maintains a map of <code>SocketID <-> Nickname</code>.</li>
			<li><strong>Routing:</strong> Incoming Mesh packets are scanned for the <code>"t"</code> (target) key. If the target matches a local Nickname, it is routed privately; otherwise, it is treated as a Room Broadcast.</li>
		</ul>

		<h3>4.3 Traffic Prioritization (QoS)</h3>
		<p>To handle the slow bit-rate of LoRa, we utilize a <strong>Priority Weighted Queue</strong>:</p>
		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Class</th>
						<th>JSON Type</th>
						<th>Behavior</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><strong>Critical</strong></td>
						<td><code>"sos"</code></td>
						<td>Interrupts current Serial transmission; zero-queue delay.</td>
					</tr>
					<tr>
						<td><strong>Standard</strong></td>
						<td><code>"msg"</code></td>
						<td>Buffered in a 50-item Circular Queue; FIFO processing.</td>
					</tr>
					<tr>
						<td><strong>System</strong></td>
						<td><code>"sys"</code></td>
						<td>Low priority; sent only when the Mesh is idle.</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

    <section id="scaling-memory">
		<h2>5. Memory, Scaling & Resource Management</h2>
		<p>The ESP32-C3 Super Mini requires strict memory partitioning and dynamic allocation to handle simultaneous WebSocket traffic and Serial LoRa data without system failure.</p>

		<h3>5.1 Memory & Buffer Management</h3>
		<p>To handle the disparity between Wi-Fi speeds (Mbps) and LoRa speeds (kbps), the gateway utilizes specific memory allocation strategies:</p>
		<ul>
			<li><strong>Circular Buffer (RingBuf):</strong> A 16KB Circular Ring Buffer is allocated in Internal RAM to act as a "Pressure Valve." When the limit is reached, it follows a <em>Tail-Drop</em> policy, overwriting the oldest data to prevent heap exhaustion.</li>
			<li><strong>Heap Fragmentation Guard:</strong> The gateway uses <code>StaticJsonDocument</code> for system packets to reserve memory at boot time, preventing the "Black Screen" crash caused by heap fragmentation.</li>
		</ul>

		

		<h3>5.2 Dynamic Scaling & Hardware Limits</h3>
		<p>Unlike fixed-cap systems, this gateway utilizes <strong>Dynamic Resource Allocation</strong> to support the maximum number of users the ESP32-C3 hardware can physically sustain.</p>
		
		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Metric</th>
						<th>Safety Threshold</th>
						<th>System Response</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><strong>Minimum Free Heap</strong></td>
						<td>40 KB</td>
						<td>Reject new WebSocket requests; Send "Server Full" 503 error.</td>
					</tr>
					<tr>
						<td><strong>Max TCP Sockets</strong></td>
						<td>Device Native (8-12)</td>
						<td>Monitor LwIP stack to prevent Wi-Fi Radio disconnection.</td>
					</tr>
					<tr>
						<td><strong>Buffer Scaling</strong></td>
						<td>Dynamic</td>
						<td>Reduce Message History depth if RAM becomes critically low.</td>
					</tr>
				</tbody>
			</table>
		</div>

		

		<h3>5.3 User Session & Slot Recovery</h3>
		<p>To ensure slots remain available for active participants, the gateway identifies and purges <strong>Zombie Connections</strong> (clients disconnected without software timeout).</p>
		
		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Mechanism</th>
						<th>Threshold</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><strong>WebSocket Heartbeat</strong></td>
						<td>20s Ping / 2 Misses</td>
						<td>Force-close socket if pongs are missed (Total ~45s).</td>
					</tr>
					<tr>
						<td><strong>Inactivity Timeout</strong></td>
						<td>5 Minutes</td>
						<td>De-authenticate idle users to free hardware sockets.</td>
					</tr>
					<tr>
						<td><strong>Pre-emptive Kick</strong></td>
						<td>Immediate</td>
						<td>If RAM is critical, kick the longest-idle user to allow new connections.</td>
					</tr>
				</tbody>
			</table>
		</div>

		

		<h3>5.4 Data Integrity & Emoji Support</h3>
		<p>The system supports UTF-8 encoded emoticons. To maintain buffer integrity, the ESP32-C3 performs <strong>Byte-Length Validation</strong> rather than character counting. This ensures that 4-byte emojis do not overflow the 240-byte Serial packet limit defined by the LoRa MTU.</p>

		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Feature</th>
						<th>Constraint</th>
						<th>Reason</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><strong>Max Message Length</strong></td>
						<td>240 Bytes</td>
						<td>LoRa MTU / Serial buffer limits.</td>
					</tr>
					<tr>
						<td><strong>Image Support</strong></td>
						<td>None</td>
						<td>RAM preservation; LoRa bandwidth limitations.</td>
					</tr>
					<tr>
						<td><strong>Local History</strong></td>
						<td>30 Messages</td>
						<td>SRAM preservation for ESP32-C3.</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

    <section id="roadmap">
		<h2>6. Implementation Roadmap</h2>
		<p>The development of the Mesh-Gateway is divided into four distinct phases, moving from local stability to long-range connectivity.</p>

		<h3>Phase 1: Local Social Hub (ESP32-C3 Focused)</h3>
		<ul>
			<li><strong>Goal:</strong> Establish a stable Wi-Fi AP and WebSocket environment on the C3.</li>
			<li><strong>Tasks:</strong> 
				<ul>
					<li>Implementation of the Captive Portal bridge.</li>
					<li>Dynamic Resource Monitor (Heap-based user scaling).</li>
					<li>Local Chat UI with Emoji support.</li>
				</ul>
			</li>
		</ul>

		

		<h3>Phase 2: The UART Bridge (Serial Logic)</h3>
		<ul>
			<li><strong>Goal:</strong> Bi-directional data flow between the C3 and the XIAO nRF52840.</li>
			<li><strong>Tasks:</strong> 
				<ul>
					<li>Programming the "Condensed JSON" parser (Option B).</li>
					<li>Implementing the Split-Horizon loop prevention logic.</li>
					<li>Serial buffer overflow testing at 115200 baud.</li>
				</ul>
			</li>
		</ul>

		

		<h3>Phase 3: Mesh Integration (LoRa Backhaul)</h3>
		<ul>
			<li><strong>Goal:</strong> Successful message delivery across two physical Gateway stations.</li>
			<li><strong>Tasks:</strong> 
				<ul>
					<li>Configuration of Meshtastic nodes for "Serial Module" mode.</li>
					<li>End-to-end latency testing between Station A (User 1) and Station B (User 2).</li>
					<li>QoS Priority Queue validation (SOS packets vs. Chat).</li>
				</ul>
			</li>
		</ul>

		

		<h3>Phase 4: Deployment & PWA Polish</h3>
		<ul>
			<li><strong>Goal:</strong> Hardening the system for field use.</li>
			<li><strong>Tasks:</strong> 
				<ul>
					<li>Finalizing the "Add to Home Screen" breakout instructions.</li>
					<li>Power consumption audit for solar-powered operation.</li>
					<li>Documentation for DIY assembly of the hardware stack.</li>
				</ul>
			</li>
		</ul>
	</section>

	<section id="dev-env">
		<h2>7. Development Environment & Tooling</h2>
		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Component</th>
						<th>Tool/Library</th>
						<th>Version</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><strong>IDE</strong></td>
						<td>VS Code + PlatformIO or Arduino IDE 2.3+</td>
						<td>Latest</td>
					</tr>
					<tr>
						<td><strong>Framework</strong></td>
						<td>ESP32 Arduino Core</td>
						<td>v3.0+ (C3 Support)</td>
					</tr>
					<tr>
						<td><strong>Web Server</strong></td>
						<td>ESPAsyncWebServer</td>
						<td>Latest</td>
					</tr>
					<tr>
						<td><strong>JSON Handler</strong></td>
						<td>ArduinoJson</td>
						<td>v7.x</td>
					</tr>
					<tr>
						<td><strong>Mesh Config</strong></td>
						<td>Meshtastic CLI / App</td>
						<td>v2.3+</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

	<section id="testing">
		<h2>8. Testing & Validation Protocols</h2>
		<p>To ensure field reliability, each node must pass the following validation checks:</p>
		
		<h3>8.1 Stress Test (User Ceiling)</h3>
		<p>Simulate 10 rapid-fire connections to verify the <strong>Heap Safety Monitor</strong> correctly rejects the 9th or 10th user once RAM drops below 40KB.</p>

		<h3>8.2 Latency Test (Serial-LoRa-Serial)</h3>
		<p>Measure the "Time to Screen" for a 200-byte message. Target: < 1.5 seconds for local processing, plus LoRa airtime.</p>
		
		

		<h3>8.3 Recovery Test (The Reaper)</h3>
		<p>Forcibly disconnect a smartphone from Wi-Fi and verify the slot is reclaimed and made available to a new user within 60 seconds.</p>
	</section>
	
	<section id="license">
		<h2>9. Licensing & Open Source</h2>
		<p>This project is developed as an <strong>Open Source</strong> initiative. All software, hardware schematics, and documentation are provided under the <strong>MIT License</strong>.</p>
		<pre>
	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files... to deal in the Software
	without restriction, including without limitation the rights to use, copy, 
	modify, merge, publish, distribute, sublicense, and/or sell copies...
		</pre>
		<p>Contributors are encouraged to fork the repository, submit pull requests, and share field-test data to improve the reliability of the Mesh-Gateway backhaul.</p>
	</section>
	
	<section id="appendix">
		<h2>Appendix: Hardware Assembly & Quick Start</h2>
		<p>This appendix provides the precise physical configuration required to realize the Mesh-Gateway using the specified hardware stack.</p>

		<h3>A.1 Wiring Diagram (UART Cross-Over)</h3>
		<p>The communication between the <strong>ESP32-C3 Super Mini</strong> and the <strong>XIAO nRF52840</strong> is a standard UART null-modem configuration.</p>
		
		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Signal</th>
						<th>ESP32-C3 Super Mini</th>
						<th>XIAO nRF52840 (Wio)</th>
						<th>Wire Color (Typical)</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><strong>Ground</strong></td>
						<td>GND</td>
						<td>GND</td>
						<td>Black</td>
					</tr>
					<tr>
						<td><strong>Data Out</strong></td>
						<td>GPIO 21 (TX)</td>
						<td>D7 (RX)</td>
						<td>Yellow/Green</td>
					</tr>
					<tr>
						<td><strong>Data In</strong></td>
						<td>GPIO 20 (RX)</td>
						<td>D6 (TX)</td>
						<td>White/Blue</td>
					</tr>
					<tr>
						<td><strong>Power (5V)</strong></td>
						<td>VCC / 5V</td>
						<td>VCC / 5V</td>
						<td>Red</td>
					</tr>
				</tbody>
			</table>
		</div>

		

		<h3>A.2 Meshtastic Node Configuration</h3>
		<p>Before the gateway can function, the XIAO nRF52840 must be configured to accept serial data via the Meshtastic firmware. Use the <code>meshtastic</code> CLI or Android/iOS app:</p>
		<pre>
	1. Set Module: <strong>Serial</strong>
	2. Serial Enabled: <strong>Enabled</strong>
	3. Baud Rate: <strong>115200</strong>
	4. Serial Mode: <strong>TEXT_MESSAGE</strong>
		</pre>

		<h3>A.3 First-Run Validation (Self-Check)</h3>
		<p>After assembly and flashing, verify the system in this order:</p>
		<ol>
			<li><strong>Wi-Fi Check:</strong> Does "Mesh-MVP-Chat" appear in your phone's Wi-Fi list?</li>
			<li><strong>Portal Check:</strong> Does the browser open to the Nickname/Instructions screen?</li>
			<li><strong>Serial Loopback:</strong> Short GPIO 20 and 21 on the ESP32; verify sent messages appear as "incoming" (validates bridge logic).</li>
			<li><strong>Mesh Check:</strong> Connect the XIAO; verify the Meshtastic "Cloud" icon appears on the device screen (if applicable).</li>
		</ol>

		
	</section>

	<footer style="margin-top: 100px; padding: 40px; text-align: center; border-top: 1px solid var(--border); color: var(--text-dim); font-size: 0.9rem;">
		<div style="font-size: 1.5rem; margin-bottom: 10px;">ðŸ”“</div>
		<strong>Mesh-Gateway Project</strong><br>
		An Open Source Communication Initiative &bull; 2026<br>
		<span style="font-size: 0.8rem; opacity: 0.7;">Released under the MIT License. No rights reserved. Build, break, and share.</span>
	</footer>

</main>

<script>
    // Simple smooth scroll for sidebar navigation
    document.querySelectorAll('nav a').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
</script>

</body>
</html>